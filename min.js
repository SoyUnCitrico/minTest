let _requestData,_requestPath;const mastercardValidity=e=>{return!!e.value.match(/^(?:5[1-5][0-9]{14})$/)},validCVV=e=>{var t=new RegExp(/^[0-9]{3,4}$/);return null!=e&&1==t.test(e)},visaValidity=e=>{return!!e.value.match(/^(?:4[0-9]{12}(?:[0-9]{3})?)$/)},mediaQuery=()=>{window.matchMedia("(max-width: 600px)").addListener(function(e){var t=document.querySelector(".formGrid"),a=document.querySelectorAll(".formItem");e.matches?(t.style.gridTemplateColumns="1fr",a.forEach((e,t)=>{e.style.width="100%",1===t&&(e.style.justifySelf="start")})):(t.style.gridTemplateColumns="1fr 1fr",a.forEach((e,t)=>{e.style.width="92%",1===t&&(e.style.justifySelf="end")}))})},validateForm=e=>{let t=!0,a=checkCVV=!1;return e.forEach(e=>{""===e.value?(e.style.border="1px solid red",t=!1):(e.style.border="1px solid black","number-card"===e.name&&(a=visaValidity(e)||mastercardValidity(e),e.style.border=a?"1px solid black":"1px solid red"),"pass"===e.name&&(checkCVV=validCVV(e.value),e.style.border=checkCVV?"1px solid black":"1px solid red"))}),checkCVV||(t=!1),t=a?t:!1},drawForm=(e,t)=>{var t=document.getElementById(t),t=(t.style.maxWidth="650px",t.style.width="90%",t.style.margin="2rem auto 1rem",t.innerHTML=`
    <section>
        <form id="cardForm">
            <label class="cardFormLabel" for="number-card">Numero de tarjeta</label>
            <input type="text" class="cardFormInput" name="number-card" required/>
            
            <div class="formGrid">

                <div class="formItem">
                    <label class="cardFormLabel" for="cardFormDate">Vencimiento</label>                    
                    <fieldset class="cardFormDate" id ="cardFormDate">                    
                        <div class="cardFormDateRange">
                            <label class="cardFormLabel">Mes</label>
                            <input type="number" class="cardFormInput"  name="expMonth" required/>
                        </div>
                        <div class="cardFormDateRange">
                            <label class="cardFormLabel">Año</label>
                            <input type="number" class="cardFormInput" name="expYear" required/>
                        </div>                    
                    </fieldset>
                </div>

                <div class="formItem">
                    <label class="cardFormLabel" for="pass">CVV</label>
                    <input type="password" class="cardFormInput" name="pass" required/>
                </div>
            </div>
            <label class="cardFormLabel" for="name">Nombre como aparece en tarjeta</label>
            <input type="text" class="cardFormInput" name="name" required/>
            <input type="submit" class="cardFormButton" value="Finalizar"/>
            
        </form>
    </section>
    `,document.getElementById("cardForm")),t=(t.style.margin="1rem auto",t.style.display="grid",t.style.minWidth="300px",t.style.padding="0.4rem 0.4rem",document.querySelector(".formGrid")),a=document.querySelectorAll(".formItem"),t=(t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",a.forEach((e,t)=>{e.style.display="grid"}),(inputDate=document.querySelectorAll(".cardFormDate .cardFormInput")).forEach((e,t)=>{e.style.display="grid",e.style.width="65%",1===t&&(e.style.alignSelf="end")}),document.querySelector(".cardFormDate"));t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",t.style.alignItems="center",t.style.border="none";document.querySelectorAll(".cardFormDateRange").forEach((e,t)=>{e.style.display="grid",e.style.width="80%",e.style.margin="0 auto",0===t?e.style.justifySelf="start":1===t&&(e.style.justifySelf="end")});a=document.querySelectorAll(".cardFormLabel"),t=document.querySelectorAll(".cardFormInput"),t=Array.prototype.slice.call(t);t.map((e,t)=>{e.style.marginTop="8px",e.style.marginBottom="0.6rem",e.style.height="24px",e.style.border="1px solid black",e.style.borderRadius="4px"});Array.prototype.slice.call(a).map((e,t)=>{e.style.fontSize="0.8rem"});a=document.querySelector(".cardFormButton");a.style.maxWidth="300px",a.style.minWidth="180px",a.style.marginTop="16px",a.style.height="32px",a.style.justifySelf="center",a.addEventListener("click",handleOnEvent(t,e))},handleOnEvent=(n,i)=>async function(e){if(e.preventDefault(),validateForm(n))try{var t,a,r,l,o,s=await validateToken(configExt.publicKey,configExt.secretKey,i);i==s.message.data[0].token&&(t=n[0].value,a=n[1].value+"/"+n[2].value,r=n[3].value,l=n[4].value,200===(o=await tokenizeCard(configExt.publicKey,configExt.secretKey,"kjh21k3jnduq23",l,t,a,r)).message.code?(console.log(o),alert(o.message.data.data[0].id)):alert("Información invalida, intentalo de nuevo"))}catch(e){console.error(e),alert("Información invalida, reiniciando el proceso....")||window.location.reload()}else alert("Revisa la informacion...")||console.log("Revisa la informacion")},getPath=e=>{e=e.match(/.+?\:\/\/.+?(\/.+?)(?:#|\?|$)/);return e&&1<e.length?e[1]:""},getQueryString=e=>{return 1<e.split("?").length?e.substring(e.indexOf("?")+1):""},getAuthHeader=(e,t,a,r)=>{var l=a.key,a=a.secret,a=CryptoJS.enc.Hex.stringify(CryptoJS.SHA512(a));let o="";var s=getPath(t),t=(_requestPath=s,getQueryString(t)),r=(o="GET"!=e&&r?JSON.stringify(r):"",(new Date).getTime());let n=[r,e,s,t,o].join("");return n=n.trim(),_requestData=n,"DynamiPay "+l+":"+r+":"+CryptoJS.enc.Hex.stringify(CryptoJS.HmacSHA256(n,a))},getToken=async(e,t)=>{e={key:e,secret:t};try{var a=getAuthHeader("GET","https://api.dynamipay.io/services/card_payment/users/create_token",e,"");return await fetch("https://api.dynamipay.io/services/card_payment/users/create_token",{method:"GET",headers:{Accept:"*/*","content-type":"application/json",authorization:a},json:!0})}catch(e){console.error(e)}},validateToken=async(e,t,a)=>{a={token:a},e={key:e,secret:t};try{var r={method:"POST",headers:{Accept:"*/*","content-type":"application/json",authorization:getAuthHeader("POST","https://api.dynamipay.io/services/card_payment/users/valid_token",e,a)},body:JSON.stringify(a),json:!0};return await fetch("https://api.dynamipay.io/services/card_payment/users/valid_token",r).then(e=>e.json()).catch(e=>(console.error(e),null))}catch(e){return console.error(e),e}},tokenizeCard=async(e,t,a,r,l,o,s)=>{console.log("TOKENIZING...");e={key:e,secret:t},t={public_key:a,pan:l,name_cc:r,sc:s,exp:o};try{var n={method:"POST",headers:{Accept:"*/*","content-type":"application/json",authorization:getAuthHeader("POST","https://api.dynamipay.io/services/card_payment/card/tokenize",e,t)},body:JSON.stringify(t),json:!0};return await fetch("https://api.dynamipay.io/services/card_payment/card/tokenize",n).then(e=>e.json()).catch(e=>(console.error("ERROR:",e),null))}catch(e){return console.error(e),e}},mainProcess=async(e,t)=>{e=await getToken(e,t).then(e=>e.json()).catch(e=>console.error(e)),t=e?.message?.data[0]?.token;console.log(e),"success"===e.status&&(drawForm(t,configExt.targetIFrame),mediaQuery())};setTimeout(()=>{document&&mainProcess(configExt.publicKey,configExt.secretKey)},400);